# Z80用 クロスアセンブラ XSM リファレンスマニュアル

## データ

### レジスタ
以下の表記が使えます。レジスタは小文字で表記しても構いません。  
未定義命令のサポートによりixh,ixlなどのインデックスレジスタの分離表記も使えます。

|レジスタの種類| 表記方法 |
|---|---|
|8bitレジスタ| ```A B C D E H L IXH IXL IYH IYL I R``` |
|16bitレジスタ| ```AF BC DE HL IX IY SP``` |
|フラグの表現|```$C $NC $Z $NZ $PE $PO $P $M```|

- メモリ参照の表記方法  
16bitレジスタが差すメモリを参照する場合は以下のように記述します。
    ```
    *HL - ニーモニックの(hl)を表す
    ```

- インデックスレジスタの表記方法  
インデックスレジスタのメモリ参照方法は以下のように記述します。

    ```
    IX[n] - ニーモニックの(IX+n)を表す
    ```

    *IX[n]ではないことに注意してください。

### 変数

変数の定義は、アセンブリ言語の DB / DW / DS 命令と同意です。
ただし、ソース上の出現位置がそのままバイナリの出現位置にはならず、プログラム領域の後ろに追加されます。
他の言語と違い初期化は行われません。プログラムがロードされたときに初期値が入っているだけです。
関数内でも初期化が必要であれば自前で行ってください。

- 型

    |型名|内容|
    |---|---|
    |byte|符号なし1バイト数値型|
    |sbyte|符号あり1バイト数値型|
    |int|符号なし2バイト数値型|
    |sint|符号あり2バイト数値型|
    |char|文字変数(1バイト)|
    |string|文字列参照型(2バイト)|

- 配列
  
    型名の後ろに角括弧```[]```を付けてサイズを指定します。

    ```
    byte[2]
    ```
  
    多次元配列は```[]```を繰り返し記述します。
    ```
    byte[2][2][2]
    ```

    初期値がある場合は要素数を省略できます。
    ```
    byte[] hoge = {1,2}
    ```

- 書式
    型名　変数名  
    型名　変数名　=　初期値  
    型名［要素数］　変数名　=　{初期値,初期値, ...}  
    型名［要素数］［要素数］　変数名　=　{{初期値,初期値, ...}}  
    型名［］　変数名　=　{初期値,初期値, ...}
    ```
    char hoge;
    byte hoge = 1;
    int[2] hoge = {1,2};
    byte[2][4] hoge = {{1,2,3,4},{5,6,7,8}};
    byte[] hoge = {1,2};
    char[] hoge = "ABCDEFG"; // 7文字+NULL文字で8バイト 
    char[][] hoge = {"ABCDEFG", "ABC"}; // 2 x 8 = 16バイト 一番長い文字列の長さに合わせます
    String hoge = "ABCDEFG"; // stringはメモリ参照型なので2バイトです。
    ```

### 定数
変数の宣言に```const``` を付けると定数になります。
数値型の定数はメモリ上にデータを持ちません。ビルド時に値がニーモニックに反映されます。
ただし```string```型は文字列が参照できるようにメモリ上に展開されます。
また、制限として定数には配列は使えません。
```
const int hoge = 0x0005;
const string hoge = "ABC";
```

### 投影
変数の宣言に```shadow```を付けると投影型になります。
```
shadow byte[10000] temp;
```
投影型はビルド後のバイナリサイズを抑えるために存在します。    
例のような変数をshadowを付けずに作ってしまうと、これだけでビルドしたサイズが10000バイト肥大してしまいます。  
これを回避するには空いているメモリに直接アクセスすればよいわけですが、その場合は途端にコーディングが面倒くさくなります。  
投影型はアドレスのマッピングだけ行い、バイナリには含めたくない場合に指定します。  
バイナリには存在しないので初期化は自力で行う必要があります。以下のコードでshadow化された変数をまとめて0で初期化できます。
```
clear _shadow, 0, _shadowSize;
```
